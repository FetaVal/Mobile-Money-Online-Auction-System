{% extends 'admin/base.html' %}

{% block extra_css %}
<style>
    .fraud-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }
    
    .fraud-stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 28px;
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        transition: transform 0.3s;
    }
    
    .fraud-stat-card:hover {
        transform: translateY(-5px);
    }
    
    .fraud-stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 120px;
        height: 120px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        transform: translate(40%, -40%);
    }
    
    .fraud-stat-card.critical {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .fraud-stat-card.high {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .fraud-stat-card.resolved {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .fraud-stat-card.total {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .stat-icon {
        font-size: 42px;
        margin-bottom: 12px;
        opacity: 0.9;
    }
    
    .stat-value {
        font-size: 48px;
        font-weight: 800;
        margin-bottom: 8px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-label {
        font-size: 15px;
        font-weight: 600;
        opacity: 0.95;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }
    
    .chart-container {
        background: white;
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 32px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .chart-title {
        font-size: 20px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .filter-section {
        background: white;
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 28px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }
    
    .bulk-actions {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        display: none;
        align-items: center;
        gap: 16px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .bulk-actions.active {
        display: flex;
    }
    
    .bulk-actions-text {
        color: white;
        font-weight: 600;
        flex: 1;
    }
    
    .alert-table-container {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .alert-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .alert-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .alert-table thead th {
        padding: 18px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .alert-table tbody tr {
        border-bottom: 1px solid #e2e8f0;
        transition: background 0.2s;
    }
    
    .alert-table tbody tr:hover {
        background: #f8fafc;
    }
    
    .alert-table tbody td {
        padding: 16px;
        color: #475569;
    }
    
    .severity-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .severity-critical {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .severity-high {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
    }
    
    .severity-medium {
        background: linear-gradient(135deg, #fddb92 0%, #d1fdff 100%);
        color: #333;
    }
    
    .severity-low {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #333;
    }
    
    .status-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
    }
    
    .status-resolved {
        background: #10b981;
        color: white;
    }
    
    .status-unresolved {
        background: #ef4444;
        color: white;
    }
    
    .action-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-resolve {
        background: #10b981;
        color: white;
    }
    
    .btn-resolve:hover {
        background: #059669;
        transform: translateY(-2px);
    }
    
    .btn-dismiss {
        background: #ef4444;
        color: white;
    }
    
    .btn-dismiss:hover {
        background: #dc2626;
        transform: translateY(-2px);
    }
    
    .btn-view {
        background: #3b82f6;
        color: white;
    }
    
    .btn-view:hover {
        background: #2563eb;
        transform: translateY(-2px);
    }
    
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    
    .modal.active {
        display: flex;
    }
    
    .modal-content {
        background: white;
        border-radius: 20px;
        max-width: 700px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        animation: modalSlideIn 0.3s;
    }
    
    @keyframes modalSlideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 28px;
        border-radius: 20px 20px 0 0;
        position: relative;
    }
    
    .modal-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
    }
    
    .modal-close {
        position: absolute;
        top: 24px;
        right: 24px;
        background: rgba(255,255,255,0.2);
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        color: white;
        font-size: 20px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .modal-close:hover {
        background: rgba(255,255,255,0.3);
    }
    
    .modal-body {
        padding: 32px 28px;
    }
    
    .detail-row {
        margin-bottom: 24px;
    }
    
    .detail-label {
        font-size: 13px;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }
    
    .detail-value {
        font-size: 16px;
        color: #1e293b;
        font-weight: 500;
    }
    
    .data-box {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        margin-top: 8px;
        border-left: 4px solid #667eea;
    }
    
    .export-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 24px;
        border-radius: 10px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        transition: all 0.3s;
    }
    
    .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        color: white;
        text-decoration: none;
    }
    
    canvas {
        max-height: 300px;
    }
    
    .checkbox-cell {
        width: 50px;
    }
    
    .alert-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .select-all-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #94a3b8;
    }
    
    .empty-state i {
        font-size: 72px;
        margin-bottom: 20px;
        opacity: 0.4;
    }
    
    .empty-state h3 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 8px;
        color: #64748b;
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="admin-header">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>üõ°Ô∏è Fraud Detection & Alerts</h1>
            <p style="color: #64748b; margin-top: 8px;">Monitor suspicious activities and protect your platform</p>
        </div>
        <a href="{% url 'admin_export_fraud_alerts' %}" class="export-btn">
            <i class="fas fa-download"></i> Export Report
        </a>
    </div>
</div>

<!-- Statistics Cards -->
<div class="fraud-stats-grid">
    <div class="fraud-stat-card total">
        <div class="stat-icon">üìä</div>
        <div class="stat-value">{{ total_alerts }}</div>
        <div class="stat-label">Total Alerts</div>
    </div>
    
    <div class="fraud-stat-card critical">
        <div class="stat-icon">üö®</div>
        <div class="stat-value">{{ critical_alerts }}</div>
        <div class="stat-label">Critical Alerts</div>
    </div>
    
    <div class="fraud-stat-card high">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-value">{{ high_alerts }}</div>
        <div class="stat-label">High Priority</div>
    </div>
    
    <div class="fraud-stat-card resolved">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value">{{ resolved_alerts }}</div>
        <div class="stat-label">Resolved</div>
    </div>
</div>

<!-- Alert Trend Chart -->
<div class="chart-container">
    <div class="chart-title">
        <i class="fas fa-chart-line"></i>
        Alert Trends (Last 7 Days)
    </div>
    <canvas id="alertTrendChart"></canvas>
</div>

<!-- Filters -->
<div class="filter-section">
    <form method="get" action="{% url 'admin_fraud_alerts' %}" id="filterForm">
        <div class="filter-grid">
            <div>
                <label style="font-size: 13px; font-weight: 600; color: #64748b; display: block; margin-bottom: 8px;">
                    <i class="fas fa-search"></i> Search
                </label>
                <input type="text" name="q" class="form-control" placeholder="Search alerts..." value="{{ search_query }}" style="border-radius: 8px;">
            </div>
            
            <div>
                <label style="font-size: 13px; font-weight: 600; color: #64748b; display: block; margin-bottom: 8px;">
                    <i class="fas fa-exclamation-triangle"></i> Severity
                </label>
                <select name="severity" class="form-control" style="border-radius: 8px;">
                    <option value="all" {% if severity_filter == 'all' %}selected{% endif %}>All Severities</option>
                    <option value="critical" {% if severity_filter == 'critical' %}selected{% endif %}>Critical</option>
                    <option value="high" {% if severity_filter == 'high' %}selected{% endif %}>High</option>
                    <option value="medium" {% if severity_filter == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="low" {% if severity_filter == 'low' %}selected{% endif %}>Low</option>
                </select>
            </div>
            
            <div>
                <label style="font-size: 13px; font-weight: 600; color: #64748b; display: block; margin-bottom: 8px;">
                    <i class="fas fa-check-circle"></i> Status
                </label>
                <select name="resolved" class="form-control" style="border-radius: 8px;">
                    <option value="unresolved" {% if resolved_filter == 'unresolved' %}selected{% endif %}>Unresolved</option>
                    <option value="resolved" {% if resolved_filter == 'resolved' %}selected{% endif %}>Resolved</option>
                    <option value="all" {% if resolved_filter == 'all' %}selected{% endif %}>All</option>
                </select>
            </div>
            
            <div>
                <label style="font-size: 13px; font-weight: 600; color: #64748b; display: block; margin-bottom: 8px;">
                    <i class="fas fa-tag"></i> Alert Type
                </label>
                <select name="alert_type" class="form-control" style="border-radius: 8px;">
                    <option value="all" {% if alert_type_filter == 'all' %}selected{% endif %}>All Types</option>
                    {% for type in alert_types %}
                    <option value="{{ type }}" {% if alert_type_filter == type %}selected{% endif %}>{{ type }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label style="font-size: 13px; font-weight: 600; color: #64748b; display: block; margin-bottom: 8px;">
                    <i class="fas fa-calendar"></i> Time Period
                </label>
                <select name="date_filter" class="form-control" style="border-radius: 8px;">
                    <option value="7" {% if date_filter == '7' %}selected{% endif %}>Last 7 Days</option>
                    <option value="30" {% if date_filter == '30' %}selected{% endif %}>Last 30 Days</option>
                    <option value="90" {% if date_filter == '90' %}selected{% endif %}>Last 90 Days</option>
                    <option value="all" {% if date_filter == 'all' %}selected{% endif %}>All Time</option>
                </select>
            </div>
            
            <div style="display: flex; align-items: flex-end;">
                <button type="submit" class="btn btn-primary w-100" style="border-radius: 8px; font-weight: 600;">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Bulk Actions Bar -->
<div class="bulk-actions" id="bulkActionsBar">
    <input type="checkbox" class="select-all-checkbox" id="selectAll">
    <div class="bulk-actions-text">
        <span id="selectedCount">0</span> alerts selected
    </div>
    <button class="action-btn btn-resolve" onclick="bulkResolveAlerts()">
        <i class="fas fa-check"></i> Resolve Selected
    </button>
    <button class="action-btn btn-dismiss" onclick="deselectAll()">
        <i class="fas fa-times"></i> Cancel
    </button>
</div>

<!-- Alerts Table -->
<div class="alert-table-container">
    <table class="alert-table">
        <thead>
            <tr>
                <th class="checkbox-cell">
                    <input type="checkbox" class="select-all-checkbox" onchange="toggleSelectAll(this)">
                </th>
                <th>Alert ID</th>
                <th>User</th>
                <th>Type</th>
                <th>Severity</th>
                <th>Description</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for alert in alerts %}
            <tr data-alert-id="{{ alert.id }}">
                <td class="checkbox-cell">
                    {% if not alert.is_resolved %}
                    <input type="checkbox" class="alert-checkbox" value="{{ alert.id }}" onchange="updateBulkActions()">
                    {% endif %}
                </td>
                <td><strong>#{{ alert.id }}</strong></td>
                <td>
                    <a href="{% url 'seller_profile' alert.user.username %}" style="color: #667eea; font-weight: 600; text-decoration: none;">
                        {{ alert.user.username }}
                    </a>
                </td>
                <td><span style="font-weight: 500;">{{ alert.alert_type }}</span></td>
                <td>
                    <span class="severity-badge severity-{{ alert.severity }}">
                        {{ alert.severity }}
                    </span>
                </td>
                <td>
                    <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {{ alert.description|truncatewords:12 }}
                    </div>
                </td>
                <td>
                    {% if alert.is_resolved %}
                        <span class="status-badge status-resolved">
                            <i class="fas fa-check-circle"></i> Resolved
                        </span>
                    {% else %}
                        <span class="status-badge status-unresolved">
                            <i class="fas fa-exclamation-circle"></i> Unresolved
                        </span>
                    {% endif %}
                </td>
                <td style="white-space: nowrap;">{{ alert.created_at|date:"M d, Y" }}<br><small style="color: #94a3b8;">{{ alert.created_at|date:"H:i" }}</small></td>
                <td style="white-space: nowrap;">
                    <button class="action-btn btn-view" onclick="viewAlertDetails({{ alert.id }}, '{{ alert.user.username }}', '{{ alert.alert_type }}', '{{ alert.severity }}', `{{ alert.description|escapejs }}`, '{{ alert.created_at|date:"M d, Y H:i" }}', {{ alert.is_resolved|lower }}, '{{ alert.resolved_by.username|default:"N/A" }}', '{{ alert.resolved_at|date:"M d, Y H:i"|default:"N/A" }}', {{ alert.data|safe }})">
                        <i class="fas fa-eye"></i>
                    </button>
                    {% if not alert.is_resolved %}
                    <button class="action-btn btn-resolve" onclick="resolveAlert({{ alert.id }})">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="action-btn btn-dismiss" onclick="dismissAlert({{ alert.id }})">
                        <i class="fas fa-trash"></i>
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" class="empty-state">
                    <i class="fas fa-shield-alt"></i>
                    <h3>No Fraud Alerts Found</h3>
                    <p>Great news! No suspicious activities detected.</p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Alert Details Modal -->
<div class="modal" id="alertModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-shield-alt"></i> Alert Details</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Dynamic content loaded here -->
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Alert Trend Chart
const dailyAlerts = {{ daily_alerts_json|safe }};
const ctx = document.getElementById('alertTrendChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: dailyAlerts.map(d => d.date),
        datasets: [{
            label: 'Fraud Alerts',
            data: dailyAlerts.map(d => d.count),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointBackgroundColor: '#667eea',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    precision: 0
                }
            }
        }
    }
});

// Bulk Actions
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.alert-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateBulkActions();
}

function updateBulkActions() {
    const selectedCheckboxes = document.querySelectorAll('.alert-checkbox:checked');
    const count = selectedCheckboxes.length;
    const bulkBar = document.getElementById('bulkActionsBar');
    const selectedCountEl = document.getElementById('selectedCount');
    
    if (count > 0) {
        bulkBar.classList.add('active');
        selectedCountEl.textContent = count;
    } else {
        bulkBar.classList.remove('active');
    }
}

function deselectAll() {
    document.querySelectorAll('.alert-checkbox').forEach(cb => cb.checked = false);
    document.querySelectorAll('.select-all-checkbox').forEach(cb => cb.checked = false);
    updateBulkActions();
}

function bulkResolveAlerts() {
    const selectedCheckboxes = document.querySelectorAll('.alert-checkbox:checked');
    const alertIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
    
    if (!confirm(`Are you sure you want to resolve ${alertIds.length} alerts?`)) {
        return;
    }
    
    fetch('{% url "admin_bulk_resolve_alerts" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ alert_ids: alertIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function resolveAlert(alertId) {
    if (!confirm('Mark this alert as resolved?')) return;
    
    fetch(`/dashboard/fraud-alerts/${alertId}/resolve/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function dismissAlert(alertId) {
    if (!confirm('Permanently delete this alert? This action cannot be undone.')) return;
    
    fetch(`/dashboard/fraud-alerts/${alertId}/dismiss/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function viewAlertDetails(id, username, type, severity, description, created, isResolved, resolvedBy, resolvedAt, data) {
    const modal = document.getElementById('alertModal');
    const modalBody = document.getElementById('modalBody');
    
    let dataDisplay = '';
    if (data && typeof data === 'object' && Object.keys(data).length > 0) {
        dataDisplay = `
            <div class="detail-row">
                <div class="detail-label">Additional Data</div>
                <div class="data-box">
                    <pre style="margin: 0; font-size: 13px; color: #475569;">${JSON.stringify(data, null, 2)}</pre>
                </div>
            </div>
        `;
    }
    
    modalBody.innerHTML = `
        <div class="detail-row">
            <div class="detail-label">Alert ID</div>
            <div class="detail-value">#${id}</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">User</div>
            <div class="detail-value">${username}</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Alert Type</div>
            <div class="detail-value">${type}</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Severity Level</div>
            <div class="detail-value">
                <span class="severity-badge severity-${severity}">${severity}</span>
            </div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Description</div>
            <div class="detail-value">${description}</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Created At</div>
            <div class="detail-value">${created}</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Status</div>
            <div class="detail-value">
                ${isResolved ? 
                    `<span class="status-badge status-resolved"><i class="fas fa-check-circle"></i> Resolved</span>` : 
                    `<span class="status-badge status-unresolved"><i class="fas fa-exclamation-circle"></i> Unresolved</span>`
                }
            </div>
        </div>
        
        ${isResolved ? `
            <div class="detail-row">
                <div class="detail-label">Resolved By</div>
                <div class="detail-value">${resolvedBy}</div>
            </div>
            
            <div class="detail-row">
                <div class="detail-label">Resolved At</div>
                <div class="detail-value">${resolvedAt}</div>
            </div>
        ` : ''}
        
        ${dataDisplay}
    `;
    
    modal.classList.add('active');
}

function closeModal() {
    document.getElementById('alertModal').classList.remove('active');
}

// Close modal on outside click
document.getElementById('alertModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}
